<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ResultSet의 캡슐화 -->
<mapper namespace="PurchaseMapper">

	<resultMap type="product" id="productSelectMap">
		<result property="fileName"  column="image_file" jdbcType="VARCHAR" />
		<result property="manuDate" column="manufacture_day" jdbcType="VARCHAR" />
		<result property="price" column="price" jdbcType="NUMERIC" />
		<result property="prodDetail" column="prod_detail" jdbcType="VARCHAR" />
		<result property="prodName" column="prod_name" jdbcType="VARCHAR" />
		<result property="prodNo"  column="prod_no" jdbcType="NUMERIC" />
		<result property="regDate" column="reg_date" jdbcType="DATE" />
		<result property="proTranCode" column="tran_status_code" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap type="purchase" id="purchaseSelectMap">	
		<result property="tranNo"  column="tran_no" jdbcType="NUMERIC" />
		<result property="tranCode" column="tran_status_code" jdbcType="VARCHAR" />
		<result property="receiverPhone" column="receiver_phone" jdbcType="VARCHAR" />
		<result property="receiverName" column="receiver_name" jdbcType="VARCHAR" />
		<result property="paymentOption" column="payment_option" jdbcType="CHAR" />
		<result property="orderDate"  column="order_date" jdbcType="DATE" />
		<result property="dlvyRequest" column="dlvy_request" jdbcType="DATE" />
		<result property="dlvyDate" column="dlvy_date" jdbcType="DATE" />
		<result property="dlvyAddr" column="demailaddr" jdbcType="VARCHAR" />
						
		<association property="purchaseProd"  javaType="Product">
			<id property="prodNo" column="prod_no"/>
			<result property="fileName"  column="image_file" jdbcType="VARCHAR" />
			<result property="manuDate" column="manufacture_day" jdbcType="VARCHAR" />
			<result property="price" column="price" jdbcType="NUMERIC" />
			<result property="prodDetail" column="prod_detail" jdbcType="VARCHAR" />
			<result property="prodName" column="prod_name" jdbcType="VARCHAR" />
			<result property="regDate" column="reg_date" jdbcType="DATE" />
			<result property="proTranCode" column="tran_status_code" jdbcType="VARCHAR" />
		</association>
		
		<association property="buyer" javaType="User">
			<id property="userId" column="buyer_id" />
			<result property="userName"	column="user_name" 		jdbcType="VARCHAR" />
			<result property="password" 	column="password" 		jdbcType="VARCHAR" />
			<result property="role" 				column="role" 					jdbcType="VARCHAR" />
			<result property="ssn" 				column="ssn" 					jdbcType="VARCHAR" />
			<result property="phone" 			column="cell_phone" 		jdbcType="VARCHAR" />
			<result property="addr" 				column="addr" 					jdbcType="VARCHAR" />
			<result property="email" 			column="email" 				jdbcType="NUMERIC"  />
			<result property="regDate" 		column="reg_date" 			jdbcType="DATE" />
		</association>
	</resultMap>
	
	<select id="findPurchase" parameterType="int" resultMap="purchaseSelectMap">
		SELECT t.*, p.*, u.*
		FROM transaction t, product p, users u
		WHERE t.prod_no = p.prod_no AND u.user_id = t.buyer_id AND tran_no = #{value}	
	</select>
	
	
	<insert id="insertPurchase" parameterType="purchase" useGeneratedKeys="true" keyProperty="tranNo">
		INSERT INTO transaction
		(TRAN_NO, PROD_NO, BUYER_ID, PAYMENT_OPTION, RECEIVER_NAME, RECEIVER_PHONE 
		,DEMAILADDR, DLVY_REQUEST,TRAN_STATUS_CODE, order_date, DLVY_DATE)
		VALUES(seq_transaction_tran_no.nextval, #{purchaseProd.prodNo:NUMERIC}, #{buyer.userId:VARCHAR}, #{paymentOption:CHAR}, 
			#{receiverName:VARCHAR}, #{receiverPhone:VARCHAR}, #{dlvyAddr : VARCHAR}, #{dlvyRequest : VARCHAR}, #{tranCode : CHAR}, 
			SYSDATE, #{dlvyDate : DATE}
		)
		
		<selectKey keyProperty="tranNo" resultType="int" order="AFTER">
    	SELECT seq_transaction_tran_no.CURRVAL FROM DUAL
    	</selectKey>
	</insert>
	
	<update id="updatePurchase" parameterType="purchase" >
		UPDATE transaction set
		payment_option = #{paymentOption:CHAR}, receiver_name = #{receiverName:VARCHAR}, receiver_phone = #{receiverPhone:VARCHAR},
		demailaddr = #{dlvyAddr : VARCHAR}, dlvy_request = #{dlvyRequest:VARCHAR}, dlvy_date = #{dlvyDate:DATE}
		WHERE tran_no = #{tranNo}
	</update>
	
	<update id="updateTransCodeByProdNo" parameterType="purchase">
		UPDATE transaction set TRAN_STATUS_CODE = #{tranCode}
		WHERE prod_no = #{purchaseProd.prodNo}
	</update>
	
 	<select id="getPurchaseList" parameterType="search" resultMap="purchaseSelectMap">
			SELECT *
			FROM 
			(	SELECT inner_table.* , ROWNUM AS row_seq
				FROM		
					(	SELECT *
						FROM transaction t
						WHERE buyer_id = #{userId}
						ORDER BY tran_no 
					) inner_table
					WHERE ROWNUM &lt;= #{endRowNum} 
			)
			WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	</select> 
	
	<select  id="getTotalCount"  parameterType="search"	 resultType="int">
	  	SELECT COUNT(*)
	  	FROM(	SELECT p.*, t.tran_status_code
						   FROM product p, transaction t
						   WHERE p.prod_no = t.prod_no(+) 
							<if test="userId != null">
						   		AND t.buyer_id = #{userId}
						   </if> 
						   <if test="searchKeyword != null">
								AND p.prod_name LIKE '%${searchKeyword}%'
									<if test="searchCondition != '' ">
										<choose>
											<when test="searchCondition == '0'">
												ORDER BY price
											</when>
											<when test="searchCondition == '1'">
												ORDER BY price DESC
											</when>
											<when test="searchCondition == '2'">
												ORDER BY reg_date DESC
											</when>
											<otherwise>
												ORDER BY p.prod_no
											</otherwise>
										</choose>																					
									</if>
							</if>
							<if test="searchKeyword == null and searchKeyword == ''">
								<if test="searchCondition != '' ">
									<choose>
										<when test="searchCondition == '0'">
											ORDER BY price
										</when>
										<when test="searchCondition == '1'">
											ORDER BY price DESC
										</when>
										<when test="searchCondition == '2'">
											ORDER BY reg_date DESC
										</when>
										<otherwise>
											ORDER BY p.prod_no
										</otherwise>
									</choose>																					
								</if>
							</if>																																		
				) countTable						
	 </select>
	 
	 <select  id="getSaleTotalCount"  parameterType="search"	 resultType="int">
	  	SELECT COUNT(*)
	  	FROM(	SELECT p.*, t.tran_status_code
						   FROM product p, transaction t
						   WHERE p.prod_no = t.prod_no(+) AND t.tran_status_code is null
						   <if test="searchKeyword != null">
								AND p.prod_name LIKE '%${searchKeyword}%'
							</if>
																																									
				) countTable						
	 </select>
	 
	 <select id="getSaleList" parameterType="search" resultMap="productSelectMap">
		SELECT *
	  	FROM (	SELECT inner_table.* , ROWNUM AS row_seq
	  				FROM ( SELECT p.*, t.tran_status_code
						   FROM product p, transaction t
						   WHERE p.prod_no = t.prod_no(+) 					   
						   <if test="searchKeyword != null">
								AND p.prod_name LIKE '%${searchKeyword}%'
									<if test="searchCondition != null">	
										<choose>
											<when test="searchCondition == 0">
												ORDER BY price
											</when>
											<when test="searchCondition == 1">
												ORDER BY price DESC
											</when>
											<when test="searchCondition == 2">
												ORDER BY reg_date DESC
											</when>
											<otherwise>
												ORDER BY p.prod_no
											</otherwise>
										</choose>																					
									</if>
							</if>
							<if test="searchKeyword == null">
								<if test="searchCondition != null">
									<choose>
										<when test="searchCondition == 0">
											ORDER BY price
										</when>
										<when test="searchCondition == 1">
											ORDER BY price DESC
										</when>
										<when test="searchCondition == 2">
											ORDER BY reg_date DESC
										</when>
										<otherwise>
											ORDER BY p.prod_no
										</otherwise>
									</choose>																					
								</if>
							</if>																																		
						) inner_table
				WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	</select>
	 
	 <update id="updateTranCode" parameterType="purchase">
		UPDATE transaction set TRAN_STATUS_CODE = #{tranCode}
		WHERE tran_no = #{tranNo}
	</update>
</mapper>